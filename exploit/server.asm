section .text
	global _start
_socket:
	mov eax,102
	mov ebx,1
	mov ecx,esp
	add ecx,4
	int 0x80
	ret 12
_bind:
	mov eax,102
	mov ebx,2
	mov ecx,esp
	add ecx,4
	int 0x80
	ret 28
_listen:
	mov eax,102
	mov ebx,4
	mov ecx,esp
	add ecx,4
	int 0x80
	ret 5

_accept:
	mov eax,102
	mov ebx,5
	mov ecx,esp
	add ecx,4
	int 0x80
	ret 12

_overflow:
	mov ebp,esp
	sub esp,256
	mov eax,esp
__copy:
	cmp byte[ecx],0
	je __done
	mov bl,byte [ecx]
	inc ecx
	mov byte [eax],bl
	inc eax
	jmp __copy
__done:
	mov esp,ebp
	ret

_start:
	push dword 6
	push dword 1
	push dword 2
	call _socket
	mov esi,eax
;esi has sockfd
	push dword 0
	push dword 0
	push dword 0
	push word 0xcca9
	push word 2
	mov edi,esp
	push dword 16
	push edi
	push esi
	call _bind

	push byte 1
	push esi
	call _listen

__callaccept:
	push dword 0
	push dword 0
	push esi
	call _accept
	mov edi,eax
;edi has connfd

	sub esp,512
	mov ecx,esp
	mov eax,3
	mov ebx,edi
	mov edx,512
	int 0x80
	mov eax,6
	mov ebx,edi
	int 0x80

	call _overflow
	add esp,512
	jmp __callaccept

	mov eax,1
	mov ebx,0
	int 0x80
